var k={isDebug:!1,customLogger:null,debugLog:(...e)=>{k.isDebug&&(k.customLogger?k.customLogger(...e):console.debug(...e))}},d=k;var A=e=>{for(let r=0;r<=e.length-4;r++)if(e[r]===79&&e[r+1]===103&&e[r+2]===103&&e[r+3]===83)return r;return-1},P=(e,r)=>{if(r+27>e.length||e[r]!==79||e[r+1]!==103||e[r+2]!==103||e[r+3]!==83)return null;let t=new DataView(e.buffer,e.byteOffset+r),s=e[r+4],a=e[r+5],i=t.getBigInt64(6,!0),n=t.getUint32(14,!0),u=t.getUint32(18,!0),c=t.getUint32(22,!0),o=e[r+26],l=0;for(let g=0;g<o;g++)l+=e[r+27+g];let m=27+o+l;return{version:s,headerType:a,granulePosition:i,serialNumber:n,pageSequence:u,checksum:c,segments:o,bodySize:l,pageSize:m,offset:r}};var G=e=>{let r=A(e);if(r===-1)throw new Error("No Ogg data found");r>0&&d.debugLog(`Skipping ${r} bytes of non-Ogg data at start`);let t=[],s=r,a=0,i,n=2,u=312,c=48e3,o=BigInt(0);for(;s<e.length;){let l=P(e,s);if(!l){d.debugLog(`Failed to parse Ogg page at offset ${s}`);break}if(a===0){i=l.serialNumber;let m=27+l.segments;n=e[s+m+9];let g=new DataView(e.buffer,e.byteOffset+s+m);u=g.getUint16(10,!0),c=g.getUint32(12,!0),d.debugLog(`OpusHead: channels=${n}, preskip=${u}, sampleRate=${c}, serial=${i}`)}else if(a===1)d.debugLog("Skipping OpusTags page");else{let m=27+l.segments,g=m+l.bodySize,p=l.granulePosition,f=Number(p-o);d.debugLog(`Data page ${a}: granule=${p}, samples=${f}, size=${l.bodySize}`),t.push({data:e.slice(s+m,s+g),samples:f}),o=p}s+=l.pageSize,a++}return d.debugLog(`Disassembled ${t.length} frames from Ogg, total granule: ${o}`),{frames:t,serialNumber:i,channels:n,preskip:u,sampleRate:c}};var S={EBML:440786851,Segment:408125543,Info:357149030,Tracks:374648427,Cluster:524531317,Timecode:231,SimpleBlock:163,BlockGroup:160,Block:161,TrackEntry:174,TrackNumber:215,TrackType:131,CodecID:134};var x=(e,r)=>{let t=e[r],s=128,a=1;for(;a<=8&&!(t&s);)s>>=1,a++;if(a>8)throw new Error("Invalid VINT");let i=t&s-1;for(let n=1;n<a;n++)i=i<<8|e[r+n];return{value:i,size:a}},z=(e,r)=>{let{value:t,size:s}=x(e,r);return{size:s,dataSize:t}},B=(e,r)=>{let t=0,{value:s,size:a}=x(e,t);t+=a;let i=e[t]<<8|e[t+1],n=r+(i<<16>>16);t+=2;let u=e[t];return t+=1,{data:e.slice(t),timestamp:n,trackNumber:s}};var{debugLog:N}=d,q=e=>{N("Extracting WebM frames");let r=W(e);N(`Extracted ${r.length} WebM frames`);let t=2,s=312,a=48e3,i=960,n=r.map(u=>({data:u.data,samples:i}));return N(`Converted to ${n.length} Opus frames`),N(`Returning Opus stream with channels=${t}, preskip=${s}, sampleRate=${a}`),{frames:n,channels:t,preskip:s,sampleRate:a}},W=e=>{let r=[],t=0,s=0,a=-1;for(;t<e.length&&!(t+8>e.length);){let{value:i,size:n}=x(e,t);t+=n;let{size:u,dataSize:c}=z(e,t);if(t+=u,t+c>e.length)break;switch(i){case S.TrackEntry:{let o=t,l=-1,m="";for(;o<t+c;){let{value:g,size:p}=x(e,o);o+=p;let{size:f,dataSize:b}=z(e,o);o+=f,g===S.TrackNumber?l=e[o]:g===S.CodecID&&(m=new TextDecoder().decode(e.slice(o,o+b))),o+=b}m==="A_OPUS"&&l!==-1&&(a=l);break}case S.Cluster:{let o=t;for(s=0;o<t+c;){let{value:l,size:m}=x(e,o);o+=m;let{size:g,dataSize:p}=z(e,o);if(o+=g,l===S.Timecode){s=0;for(let f=0;f<p;f++)s=s<<8|e[o+f]}else if(l===S.SimpleBlock){let f=e.slice(o,o+p),b=B(f,s);(a===-1||b.trackNumber===a)&&r.push(b)}else if(l===S.BlockGroup){let f=o;for(;f<o+p;){let{value:b,size:h}=x(e,f);f+=h;let{size:U,dataSize:O}=z(e,f);if(f+=U,b===S.Block){let $=e.slice(f,f+O),E=B($,s);(a===-1||E.trackNumber===a)&&r.push(E)}f+=O}}o+=p}break}}t+=c}return r};var T=(s=>(s[s.OGG_OPUS=0]="OGG_OPUS",s[s.WEBM=1]="WEBM",s[s.UNKNOWN=2]="UNKNOWN",s))(T||{});var L=e=>{if(A(e)!==-1)return 0;if(e.length>=4){let{value:t}=x(e,0);if(t===440786851)return 1}return 2};var I=e=>{let r=L(e);switch(d.debugLog(`Detected format: ${T[r]}`),r){case 0:return G(e);case 1:return q(e);case 2:throw new Error("Unknown audio format (not Ogg Opus or WebM)")}};var R=()=>{let e=new Uint32Array(256);for(let r=0;r<256;r++){let t=r<<24;for(let s=0;s<8;s++)t=t&2147483648?t<<1^79764919:t<<1;e[r]=t>>>0}return e},H=R(),v=e=>{let r=0;for(let t=0;t<e.length;t++)r=(r<<8^H[(r>>>24^e[t])&255])>>>0;return r};var C=(e,r)=>{let t="ogg-opus-concat",s=t.length,a=12+s+4,i=new Uint8Array(a),n=0;i.set(new TextEncoder().encode("OpusTags"),n),n+=8,i[n++]=s&255,i[n++]=s>>8&255,i[n++]=s>>16&255,i[n++]=s>>24&255,i.set(new TextEncoder().encode(t),n),n+=s,i[n++]=0,i[n++]=0,i[n++]=0,i[n++]=0;let u=Math.ceil(a/255),c=new Uint8Array(u);for(let p=0;p<u-1;p++)c[p]=255;c[u-1]=a%255||255;let o=27+u+a,l=new Uint8Array(o),m=new DataView(l.buffer);l[0]=79,l[1]=103,l[2]=103,l[3]=83,l[4]=0,l[5]=0,m.setBigInt64(6,BigInt(0),!0),m.setUint32(14,e,!0),m.setUint32(18,r,!0),m.setUint32(22,0,!0),l[26]=u,l.set(c,27),l.set(i,27+u);let g=v(l);return m.setUint32(22,g,!0),l},M=(e,r=2,t=312,s=48e3)=>{let a=new Uint8Array(19),i=new DataView(a.buffer),n=0;return a.set(new TextEncoder().encode("OpusHead"),n),n+=8,a[n++]=1,a[n++]=r,i.setUint16(n,t,!0),n+=2,i.setUint32(n,s,!0),n+=4,i.setInt16(n,0,!0),n+=2,a[n++]=0,F({headerType:2,granulePosition:BigInt(0),serialNumber:e,pageSequence:0,body:a})},F=e=>{let{headerType:r,granulePosition:t,serialNumber:s,pageSequence:a,body:i}=e,n=i.length,u=Math.floor(n/255),c=n%255,o=u+(c>0?1:0),l=new Uint8Array(o);for(let b=0;b<u;b++)l[b]=255;c>0&&(l[u]=c);let m=27+o+n,g=new Uint8Array(m),p=new DataView(g.buffer);g[0]=79,g[1]=103,g[2]=103,g[3]=83,g[4]=0,g[5]=r,p.setBigInt64(6,t,!0),p.setUint32(14,s,!0),p.setUint32(18,a,!0),p.setUint32(22,0,!0),g[26]=o,g.set(l,27),g.set(i,27+o);let f=v(g);return p.setUint32(22,f,!0),g};var{debugLog:w}=d,D=(e,r)=>{let t=r?.serialNumber??e.serialNumber??Math.floor(Math.random()*4294967295),s=r?.includeHeaders??!0,a=r?.startingSequence??0,i=r?.startingGranule??BigInt(0),n=[],u=0;s?(w(`Creating OpusHead: serial=${t}, channels=${e.channels}, preskip=${e.preskip}, sampleRate=${e.sampleRate}`),n.push(M(t,e.channels,e.preskip,e.sampleRate)),a++,u++,w(`Creating minimal OpusTags: sequence=${a}`),n.push(C(t,a)),a++,u++):w(`Assembling data pages only (no headers), starting at sequence=${a}, granule=${i}`);let c=4e3,o=[],l=0,m=0;for(let b of e.frames){if(l+b.data.length>c&&o.length>0){let h=new Uint8Array(l);w(`Flushing page: sequence=${a}, granule=${i}, size=${h.length}, packets=${o.length}`);let U=0;for(let $ of o)h.set($,U),U+=$.length;i+=BigInt(m);let O=F({headerType:0,granulePosition:i,serialNumber:t,pageSequence:a,body:h});n.push(O),a++,u++,o=[],l=0,m=0}o.push(b.data),l+=b.data.length,m+=b.samples}if(o.length>0){let b=new Uint8Array(l),h=0;for(let O of o)b.set(O,h),h+=O.length;i+=BigInt(m);let U=F({headerType:0,granulePosition:i,serialNumber:t,pageSequence:a,body:b});n.push(U),u++}let g=n.reduce((b,h)=>b+h.length,0),p=new Uint8Array(g),f=0;for(let b of n)p.set(b,f),f+=b.length;return w(`Assembled ${u} pages, final granule: ${i}, total size: ${p.length} bytes`),{data:p,pageCount:u,finalGranule:i}};var we=e=>{d.isDebug=e},$e=e=>{d.customLogger=e},{debugLog:y}=d,ke=e=>{if(e.length===0)throw new Error("No chunks provided");y(`
=== Concatenating ${e.length} chunks ===`);let{result:r,meta:t}=_(e[0]);return y(`First chunk prepared: ${r.length} bytes, granule=${t.cumulativeGranule}`),e.length===1||({result:r}=V(r,e.slice(1),t),y(`Final result: ${r.length} bytes
`)),r},_=e=>{y(`
=== Preparing accumulator from ${e.length} byte file ===`);let r=I(e),{data:t}=D(r,{includeHeaders:!0}),a=A(t),i=0,n=BigInt(0),u=r.serialNumber??0;for(;a<t.length;){let c=P(t,a);if(!c)break;u===0&&(u=c.serialNumber),i=c.pageSequence,c.granulePosition>n&&(n=c.granulePosition),a+=c.pageSize}return y(`Prepared accumulator: serial=${u}, lastSeq=${i}, granule=${n}, size=${t.length}`),{result:t,meta:{serialNumber:u,lastPageSequence:i,cumulativeGranule:n,totalSize:t.length}}},V=(e,r,t)=>{y(`
=== Appending ${r.length} chunks to accumulator ===`),y(`Starting state: seq=${t.lastPageSequence}, granule=${t.cumulativeGranule}, size=${t.totalSize}`);let s=[],a=t.lastPageSequence+1,i=t.cumulativeGranule;for(let o=0;o<r.length;o++){let l=r[o];y(`
--- Processing chunk ${o+1}/${r.length} (${l.length} bytes) ---`);let m=I(l),{data:g,pageCount:p,finalGranule:f}=D(m,{serialNumber:t.serialNumber,startingSequence:a,startingGranule:i,includeHeaders:!1});s.push(g),i=f,a+=p,y(`Chunk assembled: ${p} pages, granule advanced to ${f}`)}let n=e.length+s.reduce((o,l)=>o+l.length,0),u=new Uint8Array(n);u.set(e,0);let c=e.length;for(let o of s)u.set(o,c),c+=o.length;return y(`
Final state: seq=${a-1}, granule=${i}, total size=${u.length}`),{result:u,meta:{serialNumber:t.serialNumber,lastPageSequence:a-1,cumulativeGranule:i,totalSize:u.length}}};export{V as appendToAccumulator,ke as concatChunks,_ as prepareAccumulator,$e as setCustomDebugLogger,we as setDebug};
//# sourceMappingURL=index.js.map
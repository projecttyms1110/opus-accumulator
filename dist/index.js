var w={isDebug:!1,customLogger:null,debugLog:(...e)=>{w.isDebug&&(w.customLogger?w.customLogger(...e):console.debug(...e))}},P=w;var U=e=>{for(let r=0;r<=e.length-4;r++)if(e[r]===79&&e[r+1]===103&&e[r+2]===103&&e[r+3]===83)return r;return-1},z=(e,r)=>{if(r+27>e.length||e[r]!==79||e[r+1]!==103||e[r+2]!==103||e[r+3]!==83)return null;let t=new DataView(e.buffer,e.byteOffset+r),o=e[r+4],s=e[r+5],i=t.getBigInt64(6,!0),n=t.getUint32(14,!0),u=t.getUint32(18,!0),g=t.getUint32(22,!0),a=e[r+26],l=0;for(let c=0;c<a;c++)l+=e[r+27+c];let m=27+a+l;return{version:o,headerType:s,granulePosition:i,serialNumber:n,pageSequence:u,checksum:g,segments:a,bodySize:l,pageSize:m,offset:r}};var D=e=>{let r=U(e);if(r===-1)throw new Error("No Ogg data found");let t=[],o=r,s=0,i,n=2,u=312,g=48e3,a=BigInt(0);for(;o<e.length;){let l=z(e,o);if(!l)break;if(s===0){i=l.serialNumber;let m=27+l.segments;n=e[o+m+9];let c=new DataView(e.buffer,e.byteOffset+o+m);u=c.getUint16(10,!0),g=c.getUint32(12,!0)}else if(s!==1){let m=27+l.segments,c=m+l.bodySize,p=l.granulePosition,b=Number(p-a);t.push({data:e.slice(o+m,o+c),samples:b}),a=p}o+=l.pageSize,s++}return{frames:t,serialNumber:i,channels:n,preskip:u,sampleRate:g}};var y={EBML:440786851,Segment:408125543,Info:357149030,Tracks:374648427,Cluster:524531317,Timecode:231,SimpleBlock:163,BlockGroup:160,Block:161,TrackEntry:174,TrackNumber:215,TrackType:131,CodecID:134};var h=(e,r)=>{let t=e[r],o=128,s=1;for(;s<=8&&!(t&o);)o>>=1,s++;if(s>8)throw new Error("Invalid VINT");let i=t&o-1;for(let n=1;n<s;n++)i=i<<8|e[r+n];return{value:i,size:s}},A=(e,r)=>{let{value:t,size:o}=h(e,r);return{size:o,dataSize:t}},k=(e,r)=>{let t=0,{value:o,size:s}=h(e,t);t+=s;let i=e[t]<<8|e[t+1],n=r+(i<<16>>16);t+=2;let u=e[t];return t+=1,{data:e.slice(t),timestamp:n,trackNumber:o}};var v=e=>{let r=C(e),t=2,o=312,s=48e3,i=960;return{frames:r.map(u=>({data:u.data,samples:i})),channels:t,preskip:o,sampleRate:s}},C=e=>{let r=[],t=0,o=0,s=-1;for(;t<e.length&&!(t+8>e.length);){let{value:i,size:n}=h(e,t);t+=n;let{size:u,dataSize:g}=A(e,t);if(t+=u,t+g>e.length)break;switch(i){case y.TrackEntry:{let a=t,l=-1,m="";for(;a<t+g;){let{value:c,size:p}=h(e,a);a+=p;let{size:b,dataSize:f}=A(e,a);a+=b,c===y.TrackNumber?l=e[a]:c===y.CodecID&&(m=new TextDecoder().decode(e.slice(a,a+f))),a+=f}m==="A_OPUS"&&l!==-1&&(s=l);break}case y.Cluster:{let a=t;for(o=0;a<t+g;){let{value:l,size:m}=h(e,a);a+=m;let{size:c,dataSize:p}=A(e,a);if(a+=c,l===y.Timecode){o=0;for(let b=0;b<p;b++)o=o<<8|e[a+b]}else if(l===y.SimpleBlock){let b=e.slice(a,a+p),f=k(b,o);(s===-1||f.trackNumber===s)&&r.push(f)}else if(l===y.BlockGroup){let b=a;for(;b<a+p;){let{value:f,size:d}=h(e,b);b+=d;let{size:x,dataSize:S}=A(e,b);if(b+=x,f===y.Block){let O=e.slice(b,b+S),I=k(O,o);(s===-1||I.trackNumber===s)&&r.push(I)}b+=S}}a+=p}break}}t+=g}return r};var M=e=>{if(U(e)!==-1)return 0;if(e.length>=4){let{value:t}=h(e,0);if(t===440786851)return 1}return 2};var B=e=>{switch(M(e)){case 0:return D(e);case 1:return v(e);case 2:throw new Error("Unknown audio format (not Ogg Opus or WebM)")}};var W=()=>{let e=new Uint32Array(256);for(let r=0;r<256;r++){let t=r<<24;for(let o=0;o<8;o++)t=t&2147483648?t<<1^79764919:t<<1;e[r]=t>>>0}return e},L=W(),T=e=>{let r=0;for(let t=0;t<e.length;t++)r=(r<<8^L[(r>>>24^e[t])&255])>>>0;return r};var E=(e,r)=>{let t="ogg-opus-concat",o=t.length,s=12+o+4,i=new Uint8Array(s),n=0;i.set(new TextEncoder().encode("OpusTags"),n),n+=8,i[n++]=o&255,i[n++]=o>>8&255,i[n++]=o>>16&255,i[n++]=o>>24&255,i.set(new TextEncoder().encode(t),n),n+=o,i[n++]=0,i[n++]=0,i[n++]=0,i[n++]=0;let u=Math.ceil(s/255),g=new Uint8Array(u);for(let p=0;p<u-1;p++)g[p]=255;g[u-1]=s%255||255;let a=27+u+s,l=new Uint8Array(a),m=new DataView(l.buffer);l[0]=79,l[1]=103,l[2]=103,l[3]=83,l[4]=0,l[5]=0,m.setBigInt64(6,BigInt(0),!0),m.setUint32(14,e,!0),m.setUint32(18,r,!0),m.setUint32(22,0,!0),l[26]=u,l.set(g,27),l.set(i,27+u);let c=T(l);return m.setUint32(22,c,!0),l},G=(e,r=2,t=312,o=48e3)=>{let s=new Uint8Array(19),i=new DataView(s.buffer),n=0;return s.set(new TextEncoder().encode("OpusHead"),n),n+=8,s[n++]=1,s[n++]=r,i.setUint16(n,t,!0),n+=2,i.setUint32(n,o,!0),n+=4,i.setInt16(n,0,!0),n+=2,s[n++]=0,N({headerType:2,granulePosition:BigInt(0),serialNumber:e,pageSequence:0,body:s})},N=e=>{let{headerType:r,granulePosition:t,serialNumber:o,pageSequence:s,body:i}=e,n=i.length,u=Math.floor(n/255),g=n%255,a=u+(g>0?1:0),l=new Uint8Array(a);for(let f=0;f<u;f++)l[f]=255;g>0&&(l[u]=g);let m=27+a+n,c=new Uint8Array(m),p=new DataView(c.buffer);c[0]=79,c[1]=103,c[2]=103,c[3]=83,c[4]=0,c[5]=r,p.setBigInt64(6,t,!0),p.setUint32(14,o,!0),p.setUint32(18,s,!0),p.setUint32(22,0,!0),c[26]=a,c.set(l,27),c.set(i,27+a);let b=T(c);return p.setUint32(22,b,!0),c};var F=(e,r)=>{let t=r?.serialNumber??e.serialNumber??Math.floor(Math.random()*4294967295),o=r?.includeHeaders??!0,s=r?.startingSequence??0,i=r?.startingGranule??BigInt(0),n=[],u=0;o&&(n.push(G(t,e.channels,e.preskip,e.sampleRate)),s++,u++,n.push(E(t,s)),s++,u++);let g=4e3,a=[],l=0,m=0;for(let f of e.frames){if(l+f.data.length>g&&a.length>0){let d=new Uint8Array(l),x=0;for(let O of a)d.set(O,x),x+=O.length;i+=BigInt(m);let S=N({headerType:0,granulePosition:i,serialNumber:t,pageSequence:s,body:d});n.push(S),s++,u++,a=[],l=0,m=0}a.push(f.data),l+=f.data.length,m+=f.samples}if(a.length>0){let f=new Uint8Array(l),d=0;for(let S of a)f.set(S,d),d+=S.length;i+=BigInt(m);let x=N({headerType:0,granulePosition:i,serialNumber:t,pageSequence:s,body:f});n.push(x),u++}let c=n.reduce((f,d)=>f+d.length,0),p=new Uint8Array(c),b=0;for(let f of n)p.set(f,b),b+=f.length;return{data:p,pageCount:u,finalGranule:i}};var he=e=>{P.isDebug=e},Se=e=>{P.customLogger=e},xe=async e=>{if(e.length===0)throw new Error("No chunks provided");let{prepared:r,meta:t}=R(e[0]);if(e.length===1)return r;let{result:o}=_(r,e.slice(1),t);return o},R=e=>{let r=B(e),{data:t}=F(r,{includeHeaders:!0}),s=U(t),i=0,n=BigInt(0),u=r.serialNumber??0;for(;s<t.length;){let g=z(t,s);if(!g)break;u===0&&(u=g.serialNumber),i=g.pageSequence,g.granulePosition>n&&(n=g.granulePosition),s+=g.pageSize}return{prepared:t,meta:{serialNumber:u,lastPageSequence:i,cumulativeGranule:n,totalSize:t.length}}},_=(e,r,t)=>{let o=[],s=t.lastPageSequence+1,i=t.cumulativeGranule;for(let a of r){let l=B(a),{data:m,pageCount:c,finalGranule:p}=F(l,{serialNumber:t.serialNumber,startingSequence:s,startingGranule:i,includeHeaders:!1});o.push(m),i=p,s+=c}let n=e.length+o.reduce((a,l)=>a+l.length,0),u=new Uint8Array(n);u.set(e,0);let g=e.length;for(let a of o)u.set(a,g),g+=a.length;return{result:u,meta:{serialNumber:t.serialNumber,lastPageSequence:s-1,cumulativeGranule:i,totalSize:u.length}}};export{_ as addToAcc,xe as concatenateOpusFiles,R as prepareForConcat,Se as setCustomDebugLogger,he as setDebug};
//# sourceMappingURL=index.js.map
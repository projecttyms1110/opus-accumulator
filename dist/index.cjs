"use strict";var P=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var H=(e,r)=>{for(var t in r)P(e,t,{get:r[t],enumerable:!0})},V=(e,r,t,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of R(r))!_.call(e,n)&&n!==t&&P(e,n,{get:()=>r[n],enumerable:!(o=L(r,n))||o.enumerable});return e};var K=e=>V(P({},"__esModule",{value:!0}),e);var ee={};H(ee,{addToAcc:()=>W,concatenateOpusFiles:()=>$,prepareForConcat:()=>q,setCustomDebugLogger:()=>Y,setDebug:()=>Q});module.exports=K(ee);var w={isDebug:!1,customLogger:null,debugLog:(...e)=>{w.isDebug&&(w.customLogger?w.customLogger(...e):console.debug(...e))}},k=w;var U=e=>{for(let r=0;r<=e.length-4;r++)if(e[r]===79&&e[r+1]===103&&e[r+2]===103&&e[r+3]===83)return r;return-1},z=(e,r)=>{if(r+27>e.length||e[r]!==79||e[r+1]!==103||e[r+2]!==103||e[r+3]!==83)return null;let t=new DataView(e.buffer,e.byteOffset+r),o=e[r+4],n=e[r+5],i=t.getBigInt64(6,!0),s=t.getUint32(14,!0),u=t.getUint32(18,!0),g=t.getUint32(22,!0),a=e[r+26],l=0;for(let c=0;c<a;c++)l+=e[r+27+c];let m=27+a+l;return{version:o,headerType:n,granulePosition:i,serialNumber:s,pageSequence:u,checksum:g,segments:a,bodySize:l,pageSize:m,offset:r}};var v=e=>{let r=U(e);if(r===-1)throw new Error("No Ogg data found");let t=[],o=r,n=0,i,s=2,u=312,g=48e3,a=BigInt(0);for(;o<e.length;){let l=z(e,o);if(!l)break;if(n===0){i=l.serialNumber;let m=27+l.segments;s=e[o+m+9];let c=new DataView(e.buffer,e.byteOffset+o+m);u=c.getUint16(10,!0),g=c.getUint32(12,!0)}else if(n!==1){let m=27+l.segments,c=m+l.bodySize,p=l.granulePosition,b=Number(p-a);t.push({data:e.slice(o+m,o+c),samples:b}),a=p}o+=l.pageSize,n++}return{frames:t,serialNumber:i,channels:s,preskip:u,sampleRate:g}};var y={EBML:440786851,Segment:408125543,Info:357149030,Tracks:374648427,Cluster:524531317,Timecode:231,SimpleBlock:163,BlockGroup:160,Block:161,TrackEntry:174,TrackNumber:215,TrackType:131,CodecID:134};var h=(e,r)=>{let t=e[r],o=128,n=1;for(;n<=8&&!(t&o);)o>>=1,n++;if(n>8)throw new Error("Invalid VINT");let i=t&o-1;for(let s=1;s<n;s++)i=i<<8|e[r+s];return{value:i,size:n}},A=(e,r)=>{let{value:t,size:o}=h(e,r);return{size:o,dataSize:t}},B=(e,r)=>{let t=0,{value:o,size:n}=h(e,t);t+=n;let i=e[t]<<8|e[t+1],s=r+(i<<16>>16);t+=2;let u=e[t];return t+=1,{data:e.slice(t),timestamp:s,trackNumber:o}};var M=e=>{let r=X(e),t=2,o=312,n=48e3,i=960;return{frames:r.map(u=>({data:u.data,samples:i})),channels:t,preskip:o,sampleRate:n}},X=e=>{let r=[],t=0,o=0,n=-1;for(;t<e.length&&!(t+8>e.length);){let{value:i,size:s}=h(e,t);t+=s;let{size:u,dataSize:g}=A(e,t);if(t+=u,t+g>e.length)break;switch(i){case y.TrackEntry:{let a=t,l=-1,m="";for(;a<t+g;){let{value:c,size:p}=h(e,a);a+=p;let{size:b,dataSize:f}=A(e,a);a+=b,c===y.TrackNumber?l=e[a]:c===y.CodecID&&(m=new TextDecoder().decode(e.slice(a,a+f))),a+=f}m==="A_OPUS"&&l!==-1&&(n=l);break}case y.Cluster:{let a=t;for(o=0;a<t+g;){let{value:l,size:m}=h(e,a);a+=m;let{size:c,dataSize:p}=A(e,a);if(a+=c,l===y.Timecode){o=0;for(let b=0;b<p;b++)o=o<<8|e[a+b]}else if(l===y.SimpleBlock){let b=e.slice(a,a+p),f=B(b,o);(n===-1||f.trackNumber===n)&&r.push(f)}else if(l===y.BlockGroup){let b=a;for(;b<a+p;){let{value:f,size:d}=h(e,b);b+=d;let{size:x,dataSize:S}=A(e,b);if(b+=x,f===y.Block){let O=e.slice(b,b+S),D=B(O,o);(n===-1||D.trackNumber===n)&&r.push(D)}b+=S}}a+=p}break}}t+=g}return r};var E=e=>{if(U(e)!==-1)return 0;if(e.length>=4){let{value:t}=h(e,0);if(t===440786851)return 1}return 2};var T=e=>{switch(E(e)){case 0:return v(e);case 1:return M(e);case 2:throw new Error("Unknown audio format (not Ogg Opus or WebM)")}};var j=()=>{let e=new Uint32Array(256);for(let r=0;r<256;r++){let t=r<<24;for(let o=0;o<8;o++)t=t&2147483648?t<<1^79764919:t<<1;e[r]=t>>>0}return e},J=j(),F=e=>{let r=0;for(let t=0;t<e.length;t++)r=(r<<8^J[(r>>>24^e[t])&255])>>>0;return r};var G=(e,r)=>{let t="ogg-opus-concat",o=t.length,n=12+o+4,i=new Uint8Array(n),s=0;i.set(new TextEncoder().encode("OpusTags"),s),s+=8,i[s++]=o&255,i[s++]=o>>8&255,i[s++]=o>>16&255,i[s++]=o>>24&255,i.set(new TextEncoder().encode(t),s),s+=o,i[s++]=0,i[s++]=0,i[s++]=0,i[s++]=0;let u=Math.ceil(n/255),g=new Uint8Array(u);for(let p=0;p<u-1;p++)g[p]=255;g[u-1]=n%255||255;let a=27+u+n,l=new Uint8Array(a),m=new DataView(l.buffer);l[0]=79,l[1]=103,l[2]=103,l[3]=83,l[4]=0,l[5]=0,m.setBigInt64(6,BigInt(0),!0),m.setUint32(14,e,!0),m.setUint32(18,r,!0),m.setUint32(22,0,!0),l[26]=u,l.set(g,27),l.set(i,27+u);let c=F(l);return m.setUint32(22,c,!0),l},C=(e,r=2,t=312,o=48e3)=>{let n=new Uint8Array(19),i=new DataView(n.buffer),s=0;return n.set(new TextEncoder().encode("OpusHead"),s),s+=8,n[s++]=1,n[s++]=r,i.setUint16(s,t,!0),s+=2,i.setUint32(s,o,!0),s+=4,i.setInt16(s,0,!0),s+=2,n[s++]=0,N({headerType:2,granulePosition:BigInt(0),serialNumber:e,pageSequence:0,body:n})},N=e=>{let{headerType:r,granulePosition:t,serialNumber:o,pageSequence:n,body:i}=e,s=i.length,u=Math.floor(s/255),g=s%255,a=u+(g>0?1:0),l=new Uint8Array(a);for(let f=0;f<u;f++)l[f]=255;g>0&&(l[u]=g);let m=27+a+s,c=new Uint8Array(m),p=new DataView(c.buffer);c[0]=79,c[1]=103,c[2]=103,c[3]=83,c[4]=0,c[5]=r,p.setBigInt64(6,t,!0),p.setUint32(14,o,!0),p.setUint32(18,n,!0),p.setUint32(22,0,!0),c[26]=a,c.set(l,27),c.set(i,27+a);let b=F(c);return p.setUint32(22,b,!0),c};var I=(e,r)=>{let t=r?.serialNumber??e.serialNumber??Math.floor(Math.random()*4294967295),o=r?.includeHeaders??!0,n=r?.startingSequence??0,i=r?.startingGranule??BigInt(0),s=[],u=0;o&&(s.push(C(t,e.channels,e.preskip,e.sampleRate)),n++,u++,s.push(G(t,n)),n++,u++);let g=4e3,a=[],l=0,m=0;for(let f of e.frames){if(l+f.data.length>g&&a.length>0){let d=new Uint8Array(l),x=0;for(let O of a)d.set(O,x),x+=O.length;i+=BigInt(m);let S=N({headerType:0,granulePosition:i,serialNumber:t,pageSequence:n,body:d});s.push(S),n++,u++,a=[],l=0,m=0}a.push(f.data),l+=f.data.length,m+=f.samples}if(a.length>0){let f=new Uint8Array(l),d=0;for(let S of a)f.set(S,d),d+=S.length;i+=BigInt(m);let x=N({headerType:0,granulePosition:i,serialNumber:t,pageSequence:n,body:f});s.push(x),u++}let c=s.reduce((f,d)=>f+d.length,0),p=new Uint8Array(c),b=0;for(let f of s)p.set(f,b),b+=f.length;return{data:p,pageCount:u,finalGranule:i}};var Q=e=>{k.isDebug=e},Y=e=>{k.customLogger=e},$=async e=>{if(e.length===0)throw new Error("No chunks provided");let{prepared:r,meta:t}=q(e[0]);if(e.length===1)return r;let{result:o}=W(r,e.slice(1),t);return o},q=e=>{let r=T(e),{data:t}=I(r,{includeHeaders:!0}),n=U(t),i=0,s=BigInt(0),u=r.serialNumber??0;for(;n<t.length;){let g=z(t,n);if(!g)break;u===0&&(u=g.serialNumber),i=g.pageSequence,g.granulePosition>s&&(s=g.granulePosition),n+=g.pageSize}return{prepared:t,meta:{serialNumber:u,lastPageSequence:i,cumulativeGranule:s,totalSize:t.length}}},W=(e,r,t)=>{let o=[],n=t.lastPageSequence+1,i=t.cumulativeGranule;for(let a of r){let l=T(a),{data:m,pageCount:c,finalGranule:p}=I(l,{serialNumber:t.serialNumber,startingSequence:n,startingGranule:i,includeHeaders:!1});o.push(m),i=p,n+=c}let s=e.length+o.reduce((a,l)=>a+l.length,0),u=new Uint8Array(s);u.set(e,0);let g=e.length;for(let a of o)u.set(a,g),g+=a.length;return{result:u,meta:{serialNumber:t.serialNumber,lastPageSequence:n-1,cumulativeGranule:i,totalSize:u.length}}};0&&(module.exports={addToAcc,concatenateOpusFiles,prepareForConcat,setCustomDebugLogger,setDebug});
//# sourceMappingURL=index.cjs.map